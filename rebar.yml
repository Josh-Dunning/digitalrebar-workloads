barclamp:
  name: kompos8
  display: Kubernetes Composed
  license: APLv2
  copyright: "RackN, 2016"
  os_support:
    # system D only!
    - ubuntu-15.04
    - ubuntu-16.04
    - centos-7.2.1511
    - redhat-7.1

wizard:
  version: 2
  name: "Kompos8 K8s"
  description: "Install Kubernetes Cluster"
  icon: "group_work"
  system_nodes: false
  create_nodes: true
  os: true
  services:
    k8s-master: odd
    k8s-node: all
  create_size:
    default: "16 GB"
    AwsProvider: "m4.large"
    GoogleProvider: "n1-standard-16"
  deployment_size:
    k8ubernetes-master: 1
    k8ubernetes-node: 3

metadata:
  playbook_scope: node
  playbook_src_paths:
    k8: https://github.com/digitalrebar/kompos8.git
  playbook_path: k8

roles:
  - name: k8s-master
    description: 'Kubernetes Master'
    icon: "grid_on"
    type: "BarclampCluster::ServiceRole"
    jig: noop
    flags:
      - milestone
    events:
      - endpoint: inproc://role:k8s-master/on_active
        selectors:
          - event: on_active
            obj_class: role
            obj_id: k8s-master
          - event: synch_on_delete
            obj_class: role
            obj_id: k8s-master
    requires:
      - k8s-apiserver
      #- k8s-scheduler
      #- k8s-controller
    attribs:
      - name: k8s-master-network
        description: "The network of the Master nodes"
        map: 'k8s/master/network'
        default: 'node-control-address'
      - name: k8s-master-addresses
        description: "The addresses of the Master nodes"
        map: 'k8s/master/addresses'
        default: []
        schema:
          type: seq
          required: false
          sequence:
            - type: str
              pattern: /\[?[0-9a-f:.]*\]?:?[0-9]*/
      - name: k8s-master-hostnames
        description: "All hostnames of the Master nodes"
        map: 'k8s/master/hostnames'
        default: []
        schema:
          type: seq
          required: false
          sequence:
            - type: str

  - name: k8s-prereqs
    description: 'Kubernetes Setup'
    jig: ansible-playbook
    icon: "crop_free"
    flags:
      - implicit
    requires:
      - rebar-installed-node
      #- k8s-certs
      - cluster
    metadata:
      playbook_file: prereqs.yml
      playbook_combined_repo: true
    attribs:
      - name: k8s-account
        description: "Kubernetes User Account"
        map: 'k8s\account'
        default: "kube"
        schema:
          type: str
          required: true
      - name: k8s-version
        description: "The Kubernetes Version"
        map: 'k8s\version'
        default: v1.3.3
        schema:
          type: str
          required: true
      - name: k8s-strict
        description: "The Kubernetes Checksum Required"
        map: 'k8s\strict'
        default: true
        schema:
          type: bool
          required: true

# master roles

  - name: k8s-apiserver
    description: 'Kubernetes API Server'
    jig: ansible-playbook
    icon: "photo_filter"
    flags:
      - cluster
      - implicit
    requires:
      - k8s-prereqs
      #- k8s-ca
      #- k8s-ca-install-root
      #- etcd
    wants-attribs:
      - cluster-name
      - k8s-account
      #- etcd-addresses
      #- etcd-port
    metadata:
      playbook_file: apiserver.yml
      playbook_combined_repo: true
    attribs:
      - name: k8s-users
        description: "The default set of users for kubernetes API"
        map: 'k8s\users'
        default:
          kube:
            pass: changeme
            role: admin
        schema:
          type: map
          mapping:
            =:
              type: map
              mapping:
                =:
                  type: str
          required: true
      - name: k8s-log-level
        description: "The kubernetes logging level"
        map: 'k8s\log\level'
        default: 2
        schema:
          type: int
          required: true
      - name: k8s-apiserver-port
        description: "The secure port for the API server"
        map: 'k8s\apiserver\port'
        default: 443
        schema:
          type: int
          required: true
      - name: k8s-apiserver_insecure_port
        description: "The insecure port for the API server"
        map: 'k8s\apiserver\insecure_port'
        default: 8080
        schema:
          type: int
          required: true
